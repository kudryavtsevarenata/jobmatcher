import ollama
import json
from src.models import MatchResult
from config import OLLAMA_MODEL

def match_vacancies(candidate, vacancies):
    vac_text = "\n".join([
        f"{i+1}. {v['title']} | {v['company']} | {v['salary']} | {v['url']}"
        for i, v in enumerate(vacancies)
    ])

    message = f"""
Ты - профессиональный рекрутер.

Кандидат:
{candidate.model_dump_json(indent=2)}

Вакансии (оцени каждую по совпадению 0-100%):
{vac_text}

Для каждой вакансии, не пропуская ни одной, рассчитай процент совпадения по следующим критериям:

1. СОПОСТАВЛЕНИЕ ДОЛЖНОСТИ (30% веса):
   - Полное совпадение названия: 90-100%
   - Частичное совпадение (содержит ключевые слова): 70-80%
   - Смежная позиция: 50-60%
   - Несовпадение: 0-30%

2. СОВПАДЕНИЕ НАВЫКОВ (40% веса):
   - Рассчитай % совпадающих навыков: (совпавшие навыки / требуемые навыки) * 100%
   - Учитывай синонимы и уровни владения
   - Обязательные vs желательные навыки

3. СООТВЕТСТВИЕ ОПЫТУ (20% веса):
   - Опыт кандидата больше или равен требуемому: 90-100%
   - Опыт кандидата больше или равен 70% требуемого: 70-80%
   - Опыт кандидата меньше 70% требуемого: 30-50%

4. ЗАРПЛАТНЫЕ ОЖИДАНИЯ (10% веса):
   - Ожидания в рамках вилки: 90-100%
   - Ожидания на 20% выше максимума: 70-80%
   - Ожидания существенно выше: 30-50%

ПРАВИЛА ДЛЯ ПРИЧИНЫ:
- Укажи совпавшие навыки (например: "Совпадают: Python, Django, PostgreSQL")
- Укажи несоответствия (например: "Не хватает: Docker, AWS")
- Отметь опыт: "Опыт 5 лет против требуемых 3+"
- Упомяни зарплату: "Ожидания 150к в вилке 120-180к"
- Максимум 2 предложения

Верни ТОЛЬКО JSON-массив (без текста до или после JSON массива) с вакансиями, отсортированными по убыванию совпадения:
[
  {{
    "title": "...",
    "company": "...",
    "salary": "...", 
    "match_percent": 95,
    "reason": "Совпадают 8 из 10 навыков (Python, Django, SQL). Опыт 5 лет против требуемых 3+. Ожидания 150к в вилке 120-180к",
    "url": "..."
  }}
]

ТРЕБОВАНИЯ К ДАННЫМ:
- match_percent: целое число 0-100
- salary: строка (скопировать из вакансии)
- reason: конкретная причина с цифрами и фактами
"""

    response = ollama.chat(
        model=OLLAMA_MODEL,
        messages=[{
            "role": "user",
            "content": message
        }]
    )

    json_str = response["message"]["content"].strip()
    json_str = json_str.removeprefix("```json").removesuffix("```").strip()

    data = json.loads(json_str)
    return [MatchResult(**item) for item in data]
